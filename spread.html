<html>

<head>
<body>
<h1>List of observed packet formats</h1>
<select onchange="set_format()" id="fmts">
</select>
<input type="text" id="grep" onkeydown="if (event.keyCode == 13) {do_grep();
return false; }">
<input type="button" value="Filter Dests" id="send_grep"
onclick="do_grep()">&nbsp;
<input type="text" id="grep_keys" onkeydown="if (event.keyCode == 13)
{do_grep_keys(); return false; }">
<input type="button" value="Filter Keys" id="send_grep_keys"
onclick="do_grep_keys()">

<h1>Key-value pairs that appear in the format</h1>
<table id="keys">
</table>
<br><br>
<h1>Destinations address where packets of this format are send</h1>
<table id="dests">
</table>
<script>

function get_formats() {
  var opts = document.getElementById('fmts');
  opts.options.length = 0;
  l = http_get('/%%cid%%/get/opts?' + fresh()).split('\n');
  for (var j = 0; j < l.length - 1; ++j) {
    opts.add(new Option(l[j]));
  }
  opts.selectedIndex = 0;
  set_format();
}

get_formats();

function do_grep_keys() {
  var text = document.getElementById("grep_keys");
  http_get('/%%cid%%/set/grep_keys?val=' + text.value + '&' + fresh());
  get_formats();
}

function do_grep() {
  var text = document.getElementById("grep");
  http_get('/%%cid%%/set/grep?val=' + text.value + '&' + fresh());
  get_formats();
}

function http_get(url) {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.overrideMimeType('text/plain');
    xmlhttp.open("GET", url, false);
    xmlhttp.send(null);
    return xmlhttp.responseText;
}

function fresh() {
		return "t=" + new Date().getTime();
}

function set_format() {
    var sel = document.getElementById("fmts");

    http_get('/%%cid%%/set/format?val=' + sel.selectedIndex + '&' +  fresh());
    refresh();
}

function refresh() {
    build_table('keys');
    build_table('dests');
    build_range();
}

function build_range() {
    var t = document.getElementById('keys');
    for (var i = 0; i < t.rows.length; ++i) {
      var r = t.rows[i];
      var key = r.cells[0].innerHTML;
      p = http_get('/%%cid%%/get/range?key=' + key + '&' + fresh()).split('\n');
      var data = '<select onchange="narrow_key(this.id, this.value)" id=' + key + ">";
      data += "<option>*</option>";
      var selected = http_get('/%%cid%%/get/narrowed?key=' + key + '&' + fresh());
      console.log('' + p);
      for (var j = 0; j < p.length - 1; ++j) {
        if (p[j] == selected) {
          data += '<option selected="selected">' + p[j] + "</option>";
        } else {
          data += "<option>" + p[j] + "</option>";
        }
      }
      data += "</select>";
      r.insertCell(1).innerHTML = data;
      for (var j = 0; j < p.length - 1; ++j) {
        r.insertCell(j + 2).innerHTML = p[j];
      }
   }
}

function build_table(name) {
    l = http_get('/%%cid%%/get/' + name + '?' + fresh()).split('\n');
    var t = document.getElementById(name);
    n = t.rows.length;
    for (var i = n - 1; i >= 0; --i) {
      t.deleteRow(i)
    }
    for (var i = 0; i < l.length - 1; ++i) {
      var r = t.insertRow(i);
      r.insertCell(0).innerHTML = l[i];
    }
}

function narrow_key(key, value) {
  http_get('/%%cid%%/set/narrow/' + key + '/' + value + '?' + fresh());
  refresh();
}


</script>


</body>
</html>
