<html>

<head>
<body>
<h1>List of observed packet formats</h1>
<select onchange="set_format()" id="fmts">
</select>
<input type="text" id="grep" onkeydown="if (event.keyCode == 13) {do_grep();
return false; }">
<input type="button" value="Filter Dests" id="send_grep" onclick="do_grep()">

<h1>Key-value pairs that appear in the format</h1>
<table id="keys">
</table>
<br><br>
<h1>Destinations address where packets of this format are send</h1>
<table id="dests">
</table>
<script>

function get_formats() {
  var opts = document.getElementById('fmts');
  opts.options.length = 0;
  l = http_get('/%%cid%%/get/opts?' + fresh()).split('\n');
  for (var j = 0; j < l.length - 1; ++j) {
    opts.add(new Option(l[j]));
  }
  opts.selectedIndex = 0;
  set_format();
}

get_formats();

function do_grep() {
  var text = document.getElementById("grep");
  http_get('/%%cid%%/set/grep?val=' + text.value + '&' + fresh());
  get_formats();
}

function http_get(url) {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.overrideMimeType('text/plain');
    xmlhttp.open("GET", url, false);
    xmlhttp.send(null);
    return xmlhttp.responseText;
}

function fresh() {
		return "t=" + new Date().getTime();
}

function set_format() {
    var sel = document.getElementById("fmts");

    http_get('/%%cid%%/set/format?val=' + sel.selectedIndex + '&' +  fresh());
    build_table('keys');
    build_table('dests');
    build_range();
}

function build_range() {
    var t = document.getElementById('keys');
    for (var i = 0; i < t.rows.length; ++i) {
      var r = t.rows[i];
      var key = r.cells[0].innerHTML;
      p = http_get('/%%cid%%/get/range?key=' + key + '&' + fresh()).split('\n');
      for (var j = 0; j < p.length; ++j) {
        r.insertCell(j + 1).innerHTML= p[j];
      }
   }
}

function build_table(name) {
    l = http_get('/%%cid%%/get/' + name + '?' + fresh()).split('\n');
    var t = document.getElementById(name);
    n = t.rows.length;
    for (var i = n - 1; i > 0; --i) {
      t.deleteRow(i)
    }
    for (var i = 0; i < l.length; ++i) {
      var r = t.insertRow(i);
      r.insertCell(0).innerHTML= l[i];
    }
}

</script>


</body>
</html>
